<!doctype html>
<html lang="ko" data-theme="<%= typeof userTheme !== 'undefined' ? userTheme : 'light' %>">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title || "FitPlus" %></title>
    <link rel="stylesheet" href="/styles.css" />
    <script>
      // 테마 초기화 (깜빡임 방지)
      (function() {
        const savedTheme = '<%= typeof userTheme !== "undefined" ? userTheme : "system" %>';
        let theme = savedTheme;
        
        if (savedTheme === 'system') {
          theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        
        document.documentElement.setAttribute('data-theme', theme);
        
        // 시스템 테마 변경 감지
        if (savedTheme === 'system') {
          window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
          });
        }
      })();
      
      // 전역 테마 적용 함수
      function applyTheme(theme) {
        if (theme === 'system') {
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        } else {
          document.documentElement.setAttribute('data-theme', theme);
        }
      }
    </script>
  </head>
  <body>
    <% const isLoggedIn = typeof isAuthenticated !== 'undefined' && isAuthenticated; %>
    <% const userData = isLoggedIn && typeof user !== 'undefined' ? user : null; %>
    <% const displayName = (userData && userData.nickname) || "게스트"; %>
    <% const currentTab = (typeof locals !== 'undefined' && typeof locals.activeTab !== 'undefined')
      ? locals.activeTab
      : (typeof activeTab !== 'undefined' ? activeTab : ''); %>
    <% const tabClass = (name) => `tab${currentTab === name ? ' active' : ''}`; %>
    <div class="app">
      <header class="topbar">
        <div class="brand">
          <div class="logo">FitPlus</div>
          <div class="tag">AI 홈 트레이닝</div>
        </div>
        <nav class="tabs" aria-label="주요 탭">
          <a class="<%= tabClass('home') %>" href="/">Home</a>
          <a class="<%= tabClass('routine') %>" href="/routine">나의 루틴</a>
          <a class="<%= tabClass('workout') %>" href="/workout/free">자율 운동</a>
          <a class="<%= tabClass('history') %>" href="/history">운동 히스토리</a>
          <a class="<%= tabClass('quest') %>" href="/quest">퀘스트</a>
          <a class="<%= tabClass('learn') %>" href="/learn">운동 배우기</a>
        </nav>
        <div class="profile-area">
          <% if (isLoggedIn) { %>
            <a class="name" href="/settings"><%= displayName %></a>
            <a class="auth-btn logout-btn" href="/logout">로그아웃</a>
          <% } else { %>
            <span class="name"><%= displayName %></span>
            <a class="auth-btn login-btn" href="/login">로그인</a>
          <% } %>
        </div>
      </header>

      <main class="content">
        <%- body %>
      </main>
    </div>
  </body>
</html>
