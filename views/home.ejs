<div class="page active">
  <section class="page-header">
    <div>
      <h1>ë°˜ê°‘ìŠµë‹ˆë‹¤, <%= typeof user !== 'undefined' && user ? user.nickname : 'ê²ŒìŠ¤íŠ¸' %>ë‹˜!</h1>
      <p class="date"><%= today %></p>
    </div>
  </section>

  <div class="grid three">
    <!-- ì—°ì† ìš´ë™ ê¸°ë¡ ì¹´ë“œ -->
    <div class="card hero">
      <div class="card-header">
        <h3>ğŸ”¥ ë‚˜ì˜ ìš´ë™ ê¸°ë¡</h3>
      </div>
      <div class="hero-metrics">
        <div>
          <span class="metric" id="streak-count"><%= typeof streak !== 'undefined' ? streak : 0 %></span>
          <span class="metric-label">ì¼ ì—°ì†</span>
        </div>
        <div>
          <span class="metric" id="today-minutes"><%= typeof todayMinutes !== 'undefined' ? todayMinutes : 0 %></span>
          <span class="metric-label">ë¶„ ì˜¤ëŠ˜</span>
        </div>
      </div>
      <p class="muted">ê¾¸ì¤€í•¨ì´ ì‹¤ë ¥ì´ ë©ë‹ˆë‹¤!</p>
    </div>

    <!-- ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸ -->
    <div class="card">
      <div class="card-header">
        <h3>ğŸ“‹ ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸</h3>
        <a href="/quest" class="ghost" style="font-size: 12px;">ì „ì²´ë³´ê¸°</a>
      </div>
      <ul class="quest-list" id="daily-quests">
        <% if (typeof dailyQuests !== 'undefined' && dailyQuests.length > 0) { %>
          <% dailyQuests.slice(0, 3).forEach(quest => { %>
            <li class="<%= quest.status === 'DONE' || quest.progress >= quest.target ? 'completed' : '' %>">
              <span><%= quest.title %></span>
              <% if (quest.progressType === 'QUALITY') { %>
                <span class="muted"><%= quest.progress >= quest.target ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ' %></span>
              <% } else if (quest.progressType === 'HABIT') { %>
                <span class="muted"><%= quest.progress %>/<%= quest.target %>ì¼</span>
              <% } else { %>
                <span class="muted"><%= quest.progress %>/<%= quest.target %></span>
              <% } %>
            </li>
          <% }); %>
        <% } else { %>
          <li class="empty">
            <span class="muted">ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</span>
          </li>
        <% } %>
      </ul>
      <% 
        const dailyCompleted = typeof dailyQuests !== 'undefined' 
          ? dailyQuests.filter(q => q.status === 'DONE' || q.progress >= q.target).length 
          : 0;
        const dailyTotal = typeof dailyQuests !== 'undefined' ? dailyQuests.length : 0;
        const dailyProgress = dailyTotal > 0 ? Math.round((dailyCompleted / dailyTotal) * 100) : 0;
      %>
      <div class="quest">
        <div class="progress">
          <div class="progress-bar" style="width: <%= dailyProgress %>%"></div>
        </div>
        <span class="quest-progress">ì¼ì¼ í€˜ìŠ¤íŠ¸ <%= dailyCompleted %>/<%= dailyTotal %> ì™„ë£Œ</span>
      </div>
    </div>

    <!-- ì£¼ê°„ í€˜ìŠ¤íŠ¸ -->
    <div class="card">
      <div class="card-header">
        <h3>ğŸ“Š ì£¼ê°„ ëª©í‘œ</h3>
      </div>
      <ul class="quest-list" id="weekly-quests">
        <% if (typeof weeklyQuests !== 'undefined' && weeklyQuests.length > 0) { %>
          <% weeklyQuests.slice(0, 3).forEach(quest => { %>
            <li class="<%= quest.status === 'DONE' || quest.progress >= quest.target ? 'completed' : '' %>">
              <span><%= quest.title %></span>
              <% if (quest.progressType === 'QUALITY') { %>
                <span class="muted"><%= quest.progress >= quest.target ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ' %></span>
              <% } else if (quest.progressType === 'HABIT') { %>
                <span class="muted"><%= quest.progress %>/<%= quest.target %>ì¼</span>
              <% } else { %>
                <span class="muted"><%= quest.progress %>/<%= quest.target %></span>
              <% } %>
            </li>
          <% }); %>
        <% } else { %>
          <li class="empty">
            <span class="muted">ì£¼ê°„ í€˜ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</span>
          </li>
        <% } %>
      </ul>
      <% 
        const weeklyCompleted = typeof weeklyQuests !== 'undefined' 
          ? weeklyQuests.filter(q => q.status === 'DONE' || q.progress >= q.target).length 
          : 0;
        const weeklyTotal = typeof weeklyQuests !== 'undefined' ? weeklyQuests.length : 0;
        const weeklyProgress = weeklyTotal > 0 ? Math.round((weeklyCompleted / weeklyTotal) * 100) : 0;
      %>
      <div class="quest">
        <div class="progress">
          <div class="progress-bar" style="width: <%= weeklyProgress %>%"></div>
        </div>
        <span class="quest-progress">ì£¼ê°„ í€˜ìŠ¤íŠ¸ <%= weeklyCompleted %>/<%= weeklyTotal %> ì™„ë£Œ</span>
      </div>
    </div>
  </div>

  <!-- ë¹ ë¥¸ ì‹œì‘ ì„¹ì…˜ -->
  <div class="grid two">
    <!-- ë£¨í‹´ ë¹ ë¥¸ ì‹œì‘ -->
    <div class="card">
      <div class="card-header">
        <h3>âš¡ ë£¨í‹´ ë¹ ë¥¸ ì‹œì‘</h3>
        <a href="/routine" class="ghost" style="font-size: 12px;">ë£¨í‹´ ê´€ë¦¬</a>
      </div>
      <% if (typeof isAuthenticated !== 'undefined' && isAuthenticated) { %>
        <% if (typeof routines !== 'undefined' && routines.length > 0) { %>
          <div class="pill-list" id="quick-routines">
            <% routines.forEach(routine => { %>
              <div class="pill" onclick="startRoutine('<%= routine.routine_id %>')">
                ğŸ‹ï¸ <%= routine.name %>
              </div>
            <% }); %>
          </div>
        <% } else { %>
          <p class="muted">ì•„ì§ ë£¨í‹´ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ë£¨í‹´ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
        <% } %>
        <p class="card-note">
          <a href="/routine/new">+ ìƒˆ ë£¨í‹´ ë§Œë“¤ê¸°</a>
        </p>
      <% } else { %>
        <p class="muted">ë¡œê·¸ì¸í•˜ë©´ ë‚˜ë§Œì˜ ë£¨í‹´ì„ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”!</p>
        <a href="/login" class="primary full">ë¡œê·¸ì¸í•˜ê¸°</a>
      <% } %>
    </div>

    <!-- ììœ¨ ìš´ë™ -->
    <div class="card">
      <div class="card-header">
        <h3>ğŸ¯ ììœ¨ ìš´ë™</h3>
      </div>
      <p class="muted">ì›í•˜ëŠ” ìš´ë™ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì„œ ììœ ë¡­ê²Œ ìš´ë™í•˜ì„¸ìš”</p>
      <div class="chip-grid" id="exercise-chips">
        <% if (typeof exercises !== 'undefined' && exercises.length > 0) { %>
          <% exercises.forEach(exercise => { %>
            <div class="chip" onclick="startFreeWorkout('<%= exercise.code.toLowerCase() %>')">
              <%= exercise.emoji %> <%= exercise.name %>
            </div>
          <% }); %>
        <% } else { %>
          <div class="chip" onclick="startFreeWorkout('squat')">ğŸ‹ï¸ ìŠ¤ì¿¼íŠ¸</div>
          <div class="chip" onclick="startFreeWorkout('pushup')">ğŸ’ª í‘¸ì‹œì—…</div>
          <div class="chip" onclick="startFreeWorkout('lunge')">ğŸ¦µ ëŸ°ì§€</div>
          <div class="chip" onclick="startFreeWorkout('plank')">ğŸ§˜ í”Œë­í¬</div>
        <% } %>
      </div>
      <a href="/workout/free" class="ghost full" style="margin-top: 8px;">
        ì „ì²´ ìš´ë™ ë³´ê¸° â†’
      </a>
    </div>
  </div>

  <!-- ìš´ë™ íˆìŠ¤í† ë¦¬ ë¯¸ë¦¬ë³´ê¸° -->
  <div class="grid two">
    <!-- ì¶œì„ ìŠ¤íŠ¸ë¦­ -->
    <div class="card">
      <div class="card-header">
        <h3>ğŸŒ± ìš´ë™ ì¶œì„</h3>
        <a href="/history" class="ghost" style="font-size: 12px;">ë”ë³´ê¸°</a>
      </div>
      <div class="streak-grid" id="streak-grid">
        <% if (typeof activityDays !== 'undefined' && activityDays.length > 0) { %>
          <% activityDays.forEach(day => { %>
            <div class="streak <%= day.hasWorkout ? 'active' : '' %>" title="<%= day.date %>"></div>
          <% }); %>
        <% } else { %>
          <% for (let i = 0; i < 28; i++) { %>
            <div class="streak"></div>
          <% } %>
        <% } %>
      </div>
      <p class="muted">ìµœê·¼ 4ì£¼ê°„ ìš´ë™ ê¸°ë¡</p>
    </div>

    <!-- í‹°ì–´ ì •ë³´ -->
    <div class="card">
      <div class="card-header">
        <h3>ğŸ† ë‚˜ì˜ í‹°ì–´</h3>
      </div>
      <% if (typeof isAuthenticated !== 'undefined' && isAuthenticated && typeof tierInfo !== 'undefined' && tierInfo) { %>
        <div style="display: flex; align-items: center; gap: 16px;">
          <div style="font-size: 48px;"><%= tierInfo.emoji %></div>
          <div>
            <div style="font-weight: 700; font-size: 20px;"><%= tierInfo.name %></div>
            <% if (tierInfo.nextTierName) { %>
              <p class="muted">ë‹¤ìŒ í‹°ì–´ê¹Œì§€ <%= tierInfo.pointsToNext %>ì  ë‚¨ìŒ</p>
            <% } else { %>
              <p class="muted">ìµœê³  í‹°ì–´ ë‹¬ì„±! ğŸ‰</p>
            <% } %>
            <div class="progress" style="width: 200px; margin-top: 8px;">
              <div class="progress-bar" style="width: <%= tierInfo.progress %>%"></div>
            </div>
            <p class="muted" style="font-size: 12px; margin-top: 4px;">í˜„ì¬ <%= tierInfo.points %>ì </p>
          </div>
        </div>
      <% } else { %>
        <p class="muted">ë¡œê·¸ì¸í•˜ë©´ í‹°ì–´ ì‹œìŠ¤í…œì„ ì´ìš©í•  ìˆ˜ ìˆì–´ìš”!</p>
        <a href="/signup" class="primary">íšŒì›ê°€ì…</a>
      <% } %>
    </div>
  </div>

  <!-- ìš´ë™ ë°°ìš°ê¸° ì„¹ì…˜ -->
  <div class="card">
    <div class="card-header">
      <h3>ğŸ“š ìš´ë™ ë°°ìš°ê¸°</h3>
      <a href="/learn" class="primary">ì‹œì‘í•˜ê¸°</a>
    </div>
    <p class="muted">ì •í™•í•œ ìì„¸ë¥¼ ë°°ìš°ê³  ë¶€ìƒ ì—†ì´ ìš´ë™í•˜ì„¸ìš”. íŠœí† ë¦¬ì–¼ì„ ì™„ë£Œí•˜ë©´ ë³´ë„ˆìŠ¤ ì ìˆ˜ë¥¼ ë°›ì„ ìˆ˜ ìˆì–´ìš”!</p>
    <div class="pill-list">
      <% if (typeof exercises !== 'undefined' && exercises.length > 0) { %>
        <% exercises.forEach(exercise => { %>
          <span class="pill small"><%= exercise.emoji %> <%= exercise.name %> ê¸°ì´ˆ</span>
        <% }); %>
      <% } else { %>
        <span class="pill small">ğŸ‹ï¸ ìŠ¤ì¿¼íŠ¸ ê¸°ì´ˆ</span>
        <span class="pill small">ğŸ’ª í‘¸ì‹œì—… ê¸°ì´ˆ</span>
        <span class="pill small">ğŸ¦µ ëŸ°ì§€ ê¸°ì´ˆ</span>
        <span class="pill small">ğŸ§˜ í”Œë­í¬ ê¸°ì´ˆ</span>
      <% } %>
    </div>
  </div>
</div>

<style>
.quest-list li.completed span:first-child {
  text-decoration: line-through;
  opacity: 0.6;
}

.quest-list li.completed::before {
  content: 'âœ“';
  color: var(--color-success);
  margin-right: 8px;
  font-weight: bold;
}

.quest-list li.empty {
  justify-content: center;
  padding: 16px;
}

.streak-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
  margin-bottom: 8px;
}

.streak {
  width: 100%;
  aspect-ratio: 1;
  min-height: 20px;
  background: #e5e7eb;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.streak.active {
  background: var(--color-primary, #10b981);
}

.streak:hover {
  transform: scale(1.1);
}
</style>

<script>
  // ë£¨í‹´ ì‹œì‘
  function startRoutine(routineId) {
    <% if (typeof isAuthenticated !== 'undefined' && isAuthenticated) { %>
      window.location.href = `/workout/routine/${routineId}`;
    <% } else { %>
      window.location.href = '/login?error=ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤';
    <% } %>
  }

  // ììœ¨ ìš´ë™ ì‹œì‘
  function startFreeWorkout(exerciseCode) {
    <% if (typeof isAuthenticated !== 'undefined' && isAuthenticated) { %>
      window.location.href = `/workout/free/${exerciseCode}`;
    <% } else { %>
      window.location.href = '/login?error=ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤';
    <% } %>
  }
</script>
