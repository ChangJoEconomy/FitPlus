<% 
  const isRoutineMode = mode === 'ROUTINE';
  const currentExercise = exercise;
%>

<div class="workout-container">
  <!-- ìƒë‹¨ í—¤ë” -->
  <header class="workout-header">
    <div class="workout-title">
      <% if (isRoutineMode && routine) { %>
        <h2><%= routine.name %></h2>
        <span class="muted">ë£¨í‹´ ìš´ë™</span>
      <% } else { %>
        <h2><%= currentExercise.name %></h2>
        <span class="muted">ììœ¨ ìš´ë™</span>
      <% } %>
    </div>
    
    <!-- ìƒíƒœ í‘œì‹œ -->
    <div class="status-badges">
      <span class="status preparing" id="statusBadge">ì¤€ë¹„ ì¤‘</span>
    </div>

    <div class="workout-actions">
      <button class="ghost" onclick="confirmExit()">âœ• ì¢…ë£Œ</button>
    </div>
  </header>

  <!-- ì•Œë¦¼ ì˜ì—­ -->
  <div class="alert-container" id="alertContainer" hidden>
    <div class="alert">
      <strong id="alertTitle">ìì„¸ ì•Œë¦¼</strong>
      <span id="alertMessage">ë¬´ë¦ ê°ë„ë¥¼ ë” êµ½í˜€ì£¼ì„¸ìš”</span>
    </div>
  </div>

  <div class="workout-main">
    <!-- ì¹´ë©”ë¼ ì˜ì—­ -->
    <div class="camera-section">
      <div class="camera-frame" id="cameraFrame">
        <video id="videoElement" autoplay playsinline></video>
        <canvas id="poseCanvas"></canvas>
        <div class="camera-overlay" id="cameraOverlay">
          <p>ğŸ“· ì¹´ë©”ë¼ë¥¼ ì—°ê²° ì¤‘...</p>
        </div>
      </div>
      
      <!-- ì¹´ë©”ë¼ ì»¨íŠ¸ë¡¤ -->
      <div class="camera-actions" id="cameraActions">
        <button class="primary" id="startBtn" onclick="startWorkout()">
          â–¶ï¸ ìš´ë™ ì‹œì‘
        </button>
      </div>
    </div>

    <!-- ì‚¬ì´ë“œ íŒ¨ë„ -->
    <aside class="workout-sidebar">
      <!-- ì‹¤ì‹œê°„ ì ìˆ˜ -->
      <div class="card score-card">
        <div class="score-header">
          <span class="muted">ì‹¤ì‹œê°„ ì ìˆ˜</span>
        </div>
        <div class="score" id="liveScore">--</div>
        <div class="score-detail" id="scoreBreakdown">
          <!-- ì ìˆ˜ ì„¸ë¶€í•­ëª©ì´ ì—¬ê¸°ì— í‘œì‹œë¨ -->
        </div>
      </div>

      <!-- ìš´ë™ ì¹´ìš´í„° -->
      <div class="card counter-card">
        <div class="counter-row">
          <div class="counter-item">
            <span class="counter-value" id="repCount">0</span>
            <span class="counter-label">íšŸìˆ˜</span>
          </div>
          <div class="counter-item">
            <span class="counter-value" id="setCount">1</span>
            <span class="counter-label">ì„¸íŠ¸</span>
          </div>
        </div>
        <% if (isRoutineMode && routine) { %>
          <div class="progress-card">
            <span class="muted">ë£¨í‹´ ì§„í–‰</span>
            <div class="progress">
              <div class="progress-bar" id="routineProgress" style="width: 0%"></div>
            </div>
            <span class="muted" id="routineStep">1 / <%= routine.routine_setup.length %> ìš´ë™</span>
          </div>
        <% } %>
      </div>

      <!-- íƒ€ì´ë¨¸ -->
      <div class="card timer-card">
        <div class="timer-display">
          <span class="timer-value" id="timerValue">00:00</span>
          <span class="timer-label" id="timerLabel">ìš´ë™ ì‹œê°„</span>
        </div>
        <div class="rest-timer" id="restTimer" hidden>
          <span class="rest-value" id="restValue">30</span>
          <span class="rest-label">íœ´ì‹ ë‚¨ìŒ</span>
        </div>
      </div>

      <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
      <div class="control-row">
        <button class="ghost full" id="pauseBtn" onclick="togglePause()" disabled>
          â¸ï¸ ì¼ì‹œì •ì§€
        </button>
      </div>
      <div class="control-row">
        <button class="primary full" id="finishBtn" onclick="finishWorkout()" disabled>
          âœ… ìš´ë™ ì¢…ë£Œ
        </button>
      </div>
    </aside>
  </div>
</div>

<!-- ì¢…ë£Œ í™•ì¸ ëª¨ë‹¬ -->
<div class="modal" id="exitModal" hidden>
  <div class="modal-content">
    <div class="modal-header">
      <h3>ìš´ë™ ì¢…ë£Œ</h3>
      <button class="icon" onclick="closeExitModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <p>ì •ë§ë¡œ ìš´ë™ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <p class="muted">í˜„ì¬ê¹Œì§€ì˜ ê¸°ë¡ì´ ì €ì¥ë©ë‹ˆë‹¤.</p>
    </div>
    <div class="modal-actions">
      <button class="ghost" onclick="closeExitModal()">ê³„ì†í•˜ê¸°</button>
      <button class="danger" onclick="forceExit()">ì¢…ë£Œí•˜ê¸°</button>
    </div>
  </div>
</div>

<script>
  // ìš´ë™ ë°ì´í„°
  const workoutData = {
    mode: '<%= mode %>',
    exercise: <%- JSON.stringify(currentExercise) %>,
    scoringProfile: <%- scoringProfile ? JSON.stringify(scoringProfile) : 'null' %>,
    <% if (isRoutineMode) { %>
    routine: <%- JSON.stringify(routine) %>,
    routineInstance: <%- JSON.stringify(routineInstance) %>,
    <% } else { %>
    routine: null,
    routineInstance: null,
    <% } %>
  };

  // ìƒíƒœ ê´€ë¦¬
  let state = {
    phase: 'PREPARING', // PREPARING, WORKING, RESTING, PAUSED, FINISHED
    sessionId: null,
    currentSet: 1,
    currentRep: 0,
    currentStepIndex: 0,
    totalTime: 0,
    restTimeLeft: 0,
    liveScore: 0,
    isPaused: false,
    timerInterval: null,
    restInterval: null,
    alertCooldown: false
  };

  // DOM ìš”ì†Œ
  const videoElement = document.getElementById('videoElement');
  const cameraOverlay = document.getElementById('cameraOverlay');
  const statusBadge = document.getElementById('statusBadge');
  const liveScoreEl = document.getElementById('liveScore');
  const repCountEl = document.getElementById('repCount');
  const setCountEl = document.getElementById('setCount');
  const timerValueEl = document.getElementById('timerValue');
  const timerLabelEl = document.getElementById('timerLabel');
  const restTimerEl = document.getElementById('restTimer');
  const restValueEl = document.getElementById('restValue');
  const alertContainer = document.getElementById('alertContainer');
  const alertTitle = document.getElementById('alertTitle');
  const alertMessage = document.getElementById('alertMessage');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const finishBtn = document.getElementById('finishBtn');

  // ì¹´ë©”ë¼ ì´ˆê¸°í™”
  async function initCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'user', width: 640, height: 480 }
      });
      videoElement.srcObject = stream;
      cameraOverlay.innerHTML = '<p>âœ… ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ</p><p class="muted">ì „ì‹ ì´ ì˜ ë³´ì´ë„ë¡ ìœ„ì¹˜ë¥¼ ì¡°ì •í•˜ì„¸ìš”</p>';
      startBtn.disabled = false;
    } catch (error) {
      console.error('Camera error:', error);
      cameraOverlay.innerHTML = '<p>âŒ ì¹´ë©”ë¼ ì—°ê²° ì‹¤íŒ¨</p><p class="muted">ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”</p>';
    }
  }

  // ìš´ë™ ì‹œì‘
  async function startWorkout() {
    try {
      // ì„¸ì…˜ ìƒì„± API í˜¸ì¶œ
      const response = await fetch('/api/workout/session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          exercise_id: workoutData.exercise.exercise_id,
          scoring_profile_id: workoutData.scoringProfile?.scoring_profile_id,
          mode: workoutData.mode,
          routine_instance_id: workoutData.routineInstance?.routine_instance_id
        })
      });

      const data = await response.json();
      if (!response.ok) throw new Error(data.error);

      state.sessionId = data.session.session_id;
      state.phase = 'WORKING';
      
      updateStatus('running', 'ìš´ë™ ì¤‘');
      cameraOverlay.hidden = true;
      startBtn.hidden = true;
      pauseBtn.disabled = false;
      finishBtn.disabled = false;

      // íƒ€ì´ë¨¸ ì‹œì‘
      startTimer();

      // AI ì—°ë™ ì‹œì‘ (ì¶”í›„ êµ¬í˜„)
      // startPoseDetection();

    } catch (error) {
      console.error('Start error:', error);
      alert('ìš´ë™ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
  }

  // íƒ€ì´ë¨¸ ì‹œì‘
  function startTimer() {
    state.timerInterval = setInterval(() => {
      if (!state.isPaused && state.phase === 'WORKING') {
        state.totalTime++;
        updateTimerDisplay();
      }
    }, 1000);
  }

  // íƒ€ì´ë¨¸ í‘œì‹œ ì—…ë°ì´íŠ¸
  function updateTimerDisplay() {
    const mins = Math.floor(state.totalTime / 60);
    const secs = state.totalTime % 60;
    timerValueEl.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
  }

  // ìƒíƒœ ì—…ë°ì´íŠ¸
  function updateStatus(className, text) {
    statusBadge.className = 'status ' + className;
    statusBadge.textContent = text;
  }

  // ì¼ì‹œì •ì§€ í† ê¸€
  function togglePause() {
    state.isPaused = !state.isPaused;
    
    if (state.isPaused) {
      state.phase = 'PAUSED';
      updateStatus('paused', 'ì¼ì‹œì •ì§€');
      pauseBtn.innerHTML = 'â–¶ï¸ ê³„ì†í•˜ê¸°';
    } else {
      state.phase = 'WORKING';
      updateStatus('running', 'ìš´ë™ ì¤‘');
      pauseBtn.innerHTML = 'â¸ï¸ ì¼ì‹œì •ì§€';
    }
  }

  // íœ´ì‹ ì‹œì‘
  function startRest(seconds) {
    state.phase = 'RESTING';
    state.restTimeLeft = seconds;
    updateStatus('rest', 'íœ´ì‹ ì¤‘');
    timerLabelEl.textContent = 'íœ´ì‹ ì‹œê°„';
    restTimerEl.hidden = false;
    restValueEl.textContent = seconds;

    state.restInterval = setInterval(() => {
      if (!state.isPaused) {
        state.restTimeLeft--;
        restValueEl.textContent = state.restTimeLeft;

        if (state.restTimeLeft <= 0) {
          endRest();
        }
      }
    }, 1000);
  }

  // íœ´ì‹ ì¢…ë£Œ
  function endRest() {
    clearInterval(state.restInterval);
    restTimerEl.hidden = true;
    state.phase = 'WORKING';
    timerLabelEl.textContent = 'ìš´ë™ ì‹œê°„';
    updateStatus('running', 'ìš´ë™ ì¤‘');
    
    // ë‹¤ìŒ ì„¸íŠ¸ë¡œ
    state.currentSet++;
    setCountEl.textContent = state.currentSet;
    state.currentRep = 0;
    repCountEl.textContent = 0;
  }

  // ì•Œë¦¼ í‘œì‹œ
  function showAlert(title, message) {
    if (state.alertCooldown) return;

    alertTitle.textContent = title;
    alertMessage.textContent = message;
    alertContainer.hidden = false;

    state.alertCooldown = true;
    setTimeout(() => {
      alertContainer.hidden = true;
      state.alertCooldown = false;
    }, 5000);
  }

  // ì ìˆ˜ ì—…ë°ì´íŠ¸ (AIë¡œë¶€í„° í˜¸ì¶œë¨)
  function updateScore(score, breakdown) {
    state.liveScore = score;
    liveScoreEl.textContent = score;

    // ì ìˆ˜ê°€ ë‚®ìœ¼ë©´ ì•Œë¦¼
    if (score < 50 && !state.alertCooldown) {
      const worstMetric = breakdown.reduce((min, m) => m.score < min.score ? m : min, breakdown[0]);
      showAlert('ìì„¸ êµì • í•„ìš”', worstMetric.feedback || 'ìì„¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”');
    }
  }

  // íšŸìˆ˜ ì¦ê°€ (AIë¡œë¶€í„° í˜¸ì¶œë¨)
  function incrementRep() {
    state.currentRep++;
    repCountEl.textContent = state.currentRep;

    // ë£¨í‹´ ëª¨ë“œì—ì„œ ëª©í‘œ ë‹¬ì„± ì‹œ íœ´ì‹
    if (workoutData.mode === 'ROUTINE') {
      const currentStep = workoutData.routine.routine_setup[state.currentStepIndex];
      if (currentStep && currentStep.target_type === 'REPS' && state.currentRep >= currentStep.target_value) {
        if (state.currentSet < currentStep.sets) {
          startRest(currentStep.rest_sec);
        } else {
          // ë‹¤ìŒ ìš´ë™ìœ¼ë¡œ ì´ë™
          nextExercise();
        }
      }
    }
  }

  // ë‹¤ìŒ ìš´ë™ìœ¼ë¡œ (ë£¨í‹´ ëª¨ë“œ)
  function nextExercise() {
    state.currentStepIndex++;
    const routineSteps = workoutData.routine.routine_setup;

    if (state.currentStepIndex >= routineSteps.length) {
      finishWorkout();
      return;
    }

    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    const progress = (state.currentStepIndex / routineSteps.length) * 100;
    document.getElementById('routineProgress').style.width = `${progress}%`;
    document.getElementById('routineStep').textContent = 
      `${state.currentStepIndex + 1} / ${routineSteps.length} ìš´ë™`;

    // ìƒíƒœ ë¦¬ì…‹
    state.currentSet = 1;
    state.currentRep = 0;
    setCountEl.textContent = 1;
    repCountEl.textContent = 0;
  }

  // ìš´ë™ ì¢…ë£Œ
  async function finishWorkout() {
    state.phase = 'FINISHED';
    clearInterval(state.timerInterval);
    clearInterval(state.restInterval);

    try {
      // ì„¸ì…˜ ì¢…ë£Œ API í˜¸ì¶œ
      const response = await fetch(`/api/workout/session/${state.sessionId}/end`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          duration_sec: state.totalTime,
          total_reps: state.currentRep,
          final_score: state.liveScore || 0,
          summary_feedback: generateSummary()
        })
      });

      if (response.ok) {
        window.location.href = `/workout/result/${state.sessionId}`;
      } else {
        throw new Error('ì„¸ì…˜ ì¢…ë£Œ ì‹¤íŒ¨');
      }
    } catch (error) {
      console.error('Finish error:', error);
      window.location.href = '/';
    }
  }

  // ìš”ì•½ ìƒì„±
  function generateSummary() {
    if (state.liveScore >= 80) {
      return 'í›Œë¥­í•´ìš”! ìì„¸ê°€ ë§¤ìš° ì¢‹ìŠµë‹ˆë‹¤.';
    } else if (state.liveScore >= 60) {
      return 'ì¢‹ì•„ìš”! ì¡°ê¸ˆë§Œ ë” ì‹ ê²½ì“°ë©´ ì™„ë²½í•´ìš”.';
    } else {
      return 'ìì„¸ êµì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ìš´ë™ ë°°ìš°ê¸°ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.';
    }
  }

  // ì¢…ë£Œ í™•ì¸
  function confirmExit() {
    if (state.phase === 'PREPARING') {
      window.location.href = workoutData.mode === 'ROUTINE' ? '/routine' : '/workout/free';
    } else {
      document.getElementById('exitModal').hidden = false;
    }
  }

  function closeExitModal() {
    document.getElementById('exitModal').hidden = true;
  }

  function forceExit() {
    finishWorkout();
  }

  // ì´ˆê¸°í™”
  document.addEventListener('DOMContentLoaded', () => {
    initCamera();
  });
</script>
