<div class="page active">
  <section class="page-header">
    <div>
      <h1>âš™ï¸ ì„¤ì •</h1>
      <p class="muted">ê³„ì • ë° ì•± ì„¤ì •ì„ ê´€ë¦¬í•˜ì„¸ìš”</p>
    </div>
  </section>

  <div class="grid two">
    <!-- í”„ë¡œí•„ ì„¤ì • -->
    <div class="card">
      <div class="card-header">
        <h3>ğŸ‘¤ í”„ë¡œí•„ ì •ë³´</h3>
      </div>
      
      <div class="settings-section">
        <div class="settings-item">
          <div class="settings-label">
            <span class="label-text">ì•„ì´ë””</span>
            <span class="label-value"><%= userInfo.login_id %></span>
          </div>
          <span class="muted">ì•„ì´ë””ëŠ” ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</span>
        </div>
      </div>

      <form id="nickname-form" class="settings-form">
        <div class="input-group">
          <label for="nickname">ë‹‰ë„¤ì„</label>
          <div class="inline-input-row">
            <input 
              type="text" 
              id="nickname" 
              name="nickname" 
              value="<%= userInfo.nickname %>"
              minlength="2"
              maxlength="32"
              required
            />
            <button type="submit" class="primary check-button">ë³€ê²½</button>
          </div>
          <div class="field-message" id="nickname-message"></div>
        </div>
      </form>
    </div>

    <!-- í…Œë§ˆ ì„¤ì • -->
    <div class="card">
      <div class="card-header">
        <h3>ğŸ¨ í…Œë§ˆ ì„¤ì •</h3>
      </div>
      
      <div class="theme-options">
        <label class="theme-option">
          <input 
            type="radio" 
            name="theme" 
            value="light" 
            <%= settings.theme === 'light' ? 'checked' : '' %>
          />
          <div class="theme-preview light-preview">
            <div class="preview-header"></div>
            <div class="preview-content">
              <div class="preview-card"></div>
              <div class="preview-card"></div>
            </div>
          </div>
          <span class="theme-name">â˜€ï¸ ë¼ì´íŠ¸</span>
        </label>
        
        <label class="theme-option">
          <input 
            type="radio" 
            name="theme" 
            value="dark" 
            <%= settings.theme === 'dark' ? 'checked' : '' %>
          />
          <div class="theme-preview dark-preview">
            <div class="preview-header"></div>
            <div class="preview-content">
              <div class="preview-card"></div>
              <div class="preview-card"></div>
            </div>
          </div>
          <span class="theme-name">ğŸŒ™ ë‹¤í¬</span>
        </label>
        
        <label class="theme-option">
          <input 
            type="radio" 
            name="theme" 
            value="system" 
            <%= settings.theme === 'system' ? 'checked' : '' %>
          />
          <div class="theme-preview system-preview">
            <div class="preview-split">
              <div class="split-light">
                <div class="preview-header"></div>
              </div>
              <div class="split-dark">
                <div class="preview-header"></div>
              </div>
            </div>
          </div>
          <span class="theme-name">ğŸ’» ì‹œìŠ¤í…œ</span>
        </label>
      </div>
      
      <div class="field-message" id="theme-message"></div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
    <div class="card">
      <div class="card-header">
        <h3>ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
      </div>
      
      <form id="password-form" class="settings-form">
        <div class="input-group">
          <label for="currentPassword">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
          <input 
            type="password" 
            id="currentPassword" 
            name="currentPassword" 
            placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
            required
          />
        </div>
        
        <div class="input-group">
          <label for="newPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
          <input 
            type="password" 
            id="newPassword" 
            name="newPassword" 
            placeholder="8ì ì´ìƒ ì…ë ¥"
            minlength="8"
            required
          />
        </div>
        
        <div class="input-group">
          <label for="confirmPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
          <input 
            type="password" 
            id="confirmPassword" 
            name="confirmPassword" 
            placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ë‹¤ì‹œ ì…ë ¥"
            required
          />
        </div>
        
        <div class="field-message" id="password-message"></div>
        
        <button type="submit" class="primary">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
      </form>
    </div>

    <!-- ê³„ì • ì •ë³´ -->
    <div class="card">
      <div class="card-header">
        <h3>â„¹ï¸ ê³„ì • ì •ë³´</h3>
      </div>
      
      <div class="settings-section">
        <div class="settings-item">
          <div class="settings-label">
            <span class="label-text">ì•± ë²„ì „</span>
            <span class="label-value">1.0.0</span>
          </div>
        </div>
        
        <div class="settings-item">
          <div class="settings-label">
            <span class="label-text">ë¬¸ì˜í•˜ê¸°</span>
            <a href="mailto:support@fitplus.com" class="label-value link">support@fitplus.com</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ë‹‰ë„¤ì„ ë³€ê²½
  const nicknameForm = document.getElementById('nickname-form');
  const nicknameMessage = document.getElementById('nickname-message');
  
  nicknameForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const nickname = document.getElementById('nickname').value.trim();
    
    try {
      const res = await fetch('/settings/nickname', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nickname })
      });
      
      const data = await res.json();
      
      if (data.success) {
        nicknameMessage.innerHTML = '<span class="success">' + data.message + '</span>';
        // í—¤ë”ì˜ ë‹‰ë„¤ì„ë„ ì—…ë°ì´íŠ¸
        const nameEl = document.querySelector('.profile-area .name');
        if (nameEl) nameEl.textContent = nickname;
      } else {
        nicknameMessage.innerHTML = '<span class="error">' + data.message + '</span>';
      }
    } catch (err) {
      nicknameMessage.innerHTML = '<span class="error">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>';
    }
  });
  
  // í…Œë§ˆ ë³€ê²½
  const themeOptions = document.querySelectorAll('input[name="theme"]');
  const themeMessage = document.getElementById('theme-message');
  
  themeOptions.forEach(option => {
    option.addEventListener('change', async (e) => {
      const theme = e.target.value;
      
      try {
        const res = await fetch('/settings/theme', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ theme })
        });
        
        const data = await res.json();
        
        if (data.success) {
          themeMessage.innerHTML = '<span class="success">' + data.message + '</span>';
          applyTheme(theme);
        } else {
          themeMessage.innerHTML = '<span class="error">' + data.message + '</span>';
        }
      } catch (err) {
        themeMessage.innerHTML = '<span class="error">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>';
      }
    });
  });
  
  // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
  const passwordForm = document.getElementById('password-form');
  const passwordMessage = document.getElementById('password-message');
  
  passwordForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    try {
      const res = await fetch('/settings/password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ currentPassword, newPassword, confirmPassword })
      });
      
      const data = await res.json();
      
      if (data.success) {
        passwordMessage.innerHTML = '<span class="success">' + data.message + '</span>';
        passwordForm.reset();
      } else {
        passwordMessage.innerHTML = '<span class="error">' + data.message + '</span>';
      }
    } catch (err) {
      passwordMessage.innerHTML = '<span class="error">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>';
    }
  });
});

// í…Œë§ˆ ì ìš© í•¨ìˆ˜
function applyTheme(theme) {
  const html = document.documentElement;
  
  if (theme === 'system') {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    html.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
  } else {
    html.setAttribute('data-theme', theme);
  }
}
</script>
