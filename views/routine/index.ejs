<div class="page active">
  <section class="page-header">
    <div>
      <h1>ë‚˜ì˜ ë£¨í‹´</h1>
      <p class="muted">ë‚˜ë§Œì˜ ìš´ë™ ë£¨í‹´ì„ ë§Œë“¤ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
    </div>
    <div class="actions">
      <a href="/routine/new" class="primary">+ ìƒˆ ë£¨í‹´ ë§Œë“¤ê¸°</a>
    </div>
  </section>

  <% if (routines.length === 0) { %>
    <div class="card" style="text-align: center; padding: 48px;">
      <h3>ì•„ì§ ë£¨í‹´ì´ ì—†ì–´ìš”</h3>
      <p class="muted">ë‚˜ë§Œì˜ ìš´ë™ ë£¨í‹´ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
      <a href="/routine/new" class="primary" style="margin-top: 16px;">ì²« ë£¨í‹´ ë§Œë“¤ê¸°</a>
    </div>
  <% } else { %>
    <div class="grid two">
      <% routines.forEach(routine => { %>
        <div class="card" data-routine-id="<%= routine.routine_id %>">
          <div class="card-header">
            <h3><%= routine.name %></h3>
            <div class="card-actions">
              <a href="/routine/<%= routine.routine_id %>/edit" class="ghost" title="ìˆ˜ì •">âœï¸</a>
              <button class="danger" onclick="deleteRoutine('<%= routine.routine_id %>')" title="ì‚­ì œ">ğŸ—‘ï¸</button>
            </div>
          </div>
          
          <ul class="routine-list">
            <% routine.routine_setup.sort((a, b) => a.order_no - b.order_no).forEach(step => { %>
              <li>
                <strong><%= step.exercise ? step.exercise.name : 'ì•Œ ìˆ˜ ì—†ëŠ” ìš´ë™' %></strong>
                <% if (step.target_type === 'REPS') { %>
                  <%= step.target_value %>íšŒ Ã— <%= step.sets %>ì„¸íŠ¸
                <% } else { %>
                  <%= step.target_value %>ì´ˆ Ã— <%= step.sets %>ì„¸íŠ¸
                <% } %>
                <% if (step.rest_sec > 0) { %>
                  (íœ´ì‹ <%= step.rest_sec %>ì´ˆ)
                <% } %>
              </li>
            <% }); %>
          </ul>

          <div class="card-actions" style="margin-top: auto;">
            <a href="/workout/routine/<%= routine.routine_id %>" class="primary full">
              â–¶ï¸ ìš´ë™ ì‹œì‘
            </a>
          </div>
        </div>
      <% }); %>
    </div>
  <% } %>
</div>

<!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div class="modal" id="deleteModal" hidden>
  <div class="modal-content">
    <div class="modal-header">
      <h3>ë£¨í‹´ ì‚­ì œ</h3>
      <button class="icon" onclick="closeDeleteModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <p>ì •ë§ë¡œ ì´ ë£¨í‹´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <p class="muted">ì‚­ì œëœ ë£¨í‹´ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    <div class="modal-actions">
      <button class="ghost" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
      <button class="danger" id="confirmDeleteBtn">ì‚­ì œ</button>
    </div>
  </div>
</div>

<script>
  let routineToDelete = null;

  function deleteRoutine(routineId) {
    routineToDelete = routineId;
    document.getElementById('deleteModal').hidden = false;
  }

  function closeDeleteModal() {
    routineToDelete = null;
    document.getElementById('deleteModal').hidden = true;
  }

  document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
    if (!routineToDelete) return;

    try {
      const response = await fetch(`/api/routine/${routineToDelete}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
      });

      if (response.ok) {
        // í•´ë‹¹ ì¹´ë“œ ì œê±°
        const card = document.querySelector(`[data-routine-id="${routineToDelete}"]`);
        if (card) card.remove();
        closeDeleteModal();
        
        // ë£¨í‹´ì´ ì—†ìœ¼ë©´ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        if (document.querySelectorAll('[data-routine-id]').length === 0) {
          location.reload();
        }
      } else {
        const data = await response.json();
        alert(data.error || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      console.error('Delete error:', error);
      alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  });
</script>
